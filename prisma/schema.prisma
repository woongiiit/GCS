// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String
  nickname    String   @unique
  name        String
  phone       String
  memberType  String   @default("general") // "general" | "major" | "admin"
  studentId   String?  // 전공 회원일 경우만
  major       String?  // 전공 회원일 경우만
  profileImage String? // 프로필 이미지 URL
  emailVerified Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  teamMemberships  TeamMember[]    @relation("TeamMemberships")
  teams            Team[]          @relation("TeamRepresentative")
  orders           Order[]         @relation("Orders")
  reviews          Review[]        @relation("Reviews")
  posts            Post[]          @relation("Posts")
  likes            Like[]          @relation("Likes")
  notifications    Notification[]  @relation("Notifications")
  inquiries        Inquiry[]       @relation("Inquiries")
  adminLogs        AdminLog[]      @relation("AdminLogs")
  projectMembers   ProjectMember[] @relation("ProjectMembers")
}

model EmailVerification {
  id        String   @id @default(cuid())
  email     String
  code      String
  type      String   // "register" | "reset-password"
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([email, type])
  @@index([expiresAt])
}

// ============================================
// 판매팀 관련
// ============================================

model Team {
  id            String        @id @default(cuid())
  name          String        @unique
  representativeId String
  bankName      String?
  accountNumber String?
  accountHolder String?
  totalSales    Int           @default(0)
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  representative User         @relation("TeamRepresentative", fields: [representativeId], references: [id])
  members       TeamMember[]
  products      Product[]
  adjustments   Adjustment[]
  requests      TeamRequest[]
  
  @@index([representativeId])
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      String   @default("member") // "leader" | "member"
  createdAt DateTime @default(now())
  
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation("TeamMemberships", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model TeamRequest {
  id            String   @id @default(cuid())
  teamId        String
  requestedBy   String
  status        String   @default("pending") // "pending" | "approved" | "rejected"
  changes       Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  team          Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@index([teamId])
  @@index([status])
}

// ============================================
// 상품 관련
// ============================================

model Product {
  id              String            @id @default(cuid())
  name            String
  description     String?
  type            String            // "fund" | "partner"
  status          String            @default("pending") // "pending" | "active" | "completed" | "soldout"
  teamId          String
  goalAmount      Int?
  currentAmount   Int               @default(0)
  startDate       DateTime?
  endDate         DateTime?
  receiveMethod   String?
  isPublic        Boolean           @default(false)
  viewCount       Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  team            Team              @relation(fields: [teamId], references: [id])
  options         ProductOption[]
  images          ProductImage[]
  tags            ProductTag[]
  orderItems      OrderItem[]
  reviews         Review[]
  likes           Like[]            @relation("ProductLikes")
  request         ProductRequest?
  
  @@index([teamId])
  @@index([type])
  @@index([status])
  @@index([isPublic])
}

model ProductOption {
  id          String              @id @default(cuid())
  productId   String
  name        String
  values      ProductOptionValue[]
  
  product     Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@index([productId])
}

model ProductOptionValue {
  id          String   @id @default(cuid())
  optionId    String
  value       String
  price       Int?
  stock       Int?
  
  option      ProductOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  
  @@index([optionId])
}

model ProductImage {
  id          String   @id @default(cuid())
  productId   String
  url         String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@index([productId])
}

model ProductTag {
  id        String   @id @default(cuid())
  productId String
  tag       String
  
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@index([productId])
  @@index([tag])
}

model ProductRequest {
  id            String   @id @default(cuid())
  productId     String   @unique
  requestedBy   String
  status        String   @default("pending") // "pending" | "approved" | "rejected"
  requestData   Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@index([status])
  @@index([requestedBy])
}

// ============================================
// 주문 관련
// ============================================

model Order {
  id              String      @id @default(cuid())
  userId          String
  status          String      @default("pending") // "pending" | "confirmed" | "processing" | "shipped" | "delivered" | "cancelled"
  totalAmount     Int
  shippingAddress String?
  shippingName    String?
  shippingPhone   String?
  memo            String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  user            User        @relation("Orders", fields: [userId], references: [id])
  items           OrderItem[]
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productId   String
  quantity    Int
  price       Int
  optionData  Json?
  createdAt   DateTime @default(now())
  
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])
  
  @@index([orderId])
  @@index([productId])
}

// ============================================
// 리뷰 관련
// ============================================

model Review {
  id          String        @id @default(cuid())
  userId      String
  productId   String
  orderId     String?
  rating      Int
  content     String
  images      ReviewImage[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  user        User          @relation("Reviews", fields: [userId], references: [id])
  product     Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([productId])
  @@index([rating])
  @@index([createdAt])
}

model ReviewImage {
  id        String   @id @default(cuid())
  reviewId  String
  url       String
  order     Int      @default(0)
  createdAt DateTime @default(now())
  
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  
  @@index([reviewId])
}

// ============================================
// 커뮤니티 관련
// ============================================

model Post {
  id          String    @id @default(cuid())
  userId      String
  category    String    // "board" | "lounge"
  title       String
  subtitle    String?
  content     String?
  thumbnail   String?
  viewCount   Int       @default(0)
  isPublic    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  user        User      @relation("Posts", fields: [userId], references: [id])
  likes       Like[]    @relation("PostLikes")
  
  @@index([userId])
  @@index([category])
  @@index([isPublic])
  @@index([createdAt])
}

// ============================================
// 아카이브 관련
// ============================================

model Project {
  id          String          @id @default(cuid())
  title       String
  description String?
  teamName    String?
  year        Int
  category    String?
  thumbnail   String?
  content     String?
  viewCount   Int             @default(0)
  isPublic    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  tags        ProjectTag[]
  members     ProjectMember[]
  
  @@index([year])
  @@index([category])
  @@index([isPublic])
  @@index([createdAt])
}

model News {
  id          String    @id @default(cuid())
  title       String
  content     String?
  link        String?
  year        Int
  isHeadline  Boolean   @default(false)
  isPublic    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([year])
  @@index([isHeadline])
  @@index([isPublic])
  @@index([createdAt])
}

model Tag {
  id        String       @id @default(cuid())
  name      String       @unique
  projects  ProjectTag[]
  
  @@index([name])
}

model ProjectTag {
  id        String   @id @default(cuid())
  projectId String
  tagId     String
  
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, tagId])
  @@index([projectId])
  @@index([tagId])
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  createdAt DateTime @default(now())
  
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation("ProjectMembers", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

// ============================================
// 알림 및 좋아요
// ============================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  content   String?
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  user      User     @relation("Notifications", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  productId String?
  postId    String?
  createdAt DateTime @default(now())
  
  user      User     @relation("Likes", fields: [userId], references: [id], onDelete: Cascade)
  product   Product? @relation("ProductLikes", fields: [productId], references: [id], onDelete: Cascade)
  post      Post?    @relation("PostLikes", fields: [postId], references: [id], onDelete: Cascade)
  
  @@unique([userId, productId])
  @@unique([userId, postId])
  @@index([userId])
  @@index([productId])
  @@index([postId])
}

// ============================================
// 정산 관련
// ============================================

model Adjustment {
  id            String           @id @default(cuid())
  teamId        String
  periodStart   DateTime
  periodEnd     DateTime
  totalAmount   Int
  status        String           @default("pending") // "pending" | "completed" | "cancelled"
  paidAt        DateTime?
  memo          String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  
  team          Team             @relation(fields: [teamId], references: [id])
  items         AdjustmentItem[]
  
  @@index([teamId])
  @@index([status])
  @@index([periodStart, periodEnd])
}

model AdjustmentItem {
  id            String     @id @default(cuid())
  adjustmentId  String
  orderId       String?
  productId     String?
  amount        Int
  description   String?
  createdAt     DateTime   @default(now())
  
  adjustment    Adjustment @relation(fields: [adjustmentId], references: [id], onDelete: Cascade)
  
  @@index([adjustmentId])
  @@index([orderId])
  @@index([productId])
}

// ============================================
// 기타
// ============================================

model Inquiry {
  id          String   @id @default(cuid())
  userId      String?
  type        String
  title       String
  content     String
  email       String?
  phone       String?
  status      String   @default("pending") // "pending" | "answered" | "closed"
  answer      String?
  answeredAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User?    @relation("Inquiries", fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model AdminLog {
  id          String   @id @default(cuid())
  adminId     String
  action      String
  targetType  String?
  targetId    String?
  details     Json?
  ipAddress   String?
  createdAt   DateTime @default(now())
  
  admin       User     @relation("AdminLogs", fields: [adminId], references: [id])
  
  @@index([adminId])
  @@index([action])
  @@index([targetType, targetId])
  @@index([createdAt])
}

